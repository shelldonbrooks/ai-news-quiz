<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“° News Quiz</title>
<link rel="icon" type="image/svg+xml" href="/favicon.svg">
<style>
:root {
  --bg:#0a0e1a; --card:#111827; --border:#1f2937;
  --accent:#38bdf8; --green:#22c55e; --red:#ef4444;
  --text:#e2e8f0; --muted:#6b7280;
  --de:#e8c84a; --world:#38bdf8; --history:#f59e0b;
}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;min-height:100vh}

/* â”€â”€ HEADER â”€â”€ */
header{text-align:center;padding:1.75rem 1rem 1rem;border-bottom:1px solid var(--border)}
header h1{font-size:1.8rem;margin-bottom:.25rem}
header p{color:var(--muted);font-size:.9rem}
.date-badge{display:inline-block;margin-top:.5rem;padding:.2rem .7rem;background:#1f2937;border-radius:99px;font-size:.78rem;color:var(--accent)}

/* â”€â”€ MAIN MENU â”€â”€ */
#menu{max-width:600px;margin:0 auto;padding:1.5rem 1rem}
.menu-title{text-align:center;font-size:.8rem;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;margin-bottom:1rem}
.menu-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:.9rem}
@media(max-width:600px){.menu-grid{grid-template-columns:1fr 1fr}}
.mode-btn{
  display:flex;flex-direction:column;align-items:center;gap:.4rem;
  padding:1.1rem .75rem;border-radius:14px;cursor:pointer;
  border:2px solid var(--border);background:var(--card);
  transition:all .22s;color:var(--text)
}
.mode-btn:hover{transform:translateY(-3px);box-shadow:0 8px 24px rgba(0,0,0,.4)}
.mode-btn.de{border-color:var(--de)}.mode-btn.de:hover{background:#1a1810}
.mode-btn.world{border-color:var(--world)}.mode-btn.world:hover{background:#0d1f2a}
.mode-btn.collage{border-color:#a78bfa}.mode-btn.collage:hover{background:#180f2a}
.mode-btn.history{border-color:var(--history)}.mode-btn.history:hover{background:#1a1200}
.mode-btn.fullday{border-color:var(--green);grid-column:1/-1}.mode-btn.fullday:hover{background:#051a0e}
.mode-btn.fullday .mode-label{font-size:1.05rem}
/* Year event label */
.year-event-label{padding:.6rem .75rem;background:var(--card);border:1px solid var(--border);border-radius:8px;margin-bottom:.6rem;font-size:.875rem;font-weight:600;color:var(--text);line-height:1.35}
/* Fullday bridge overlay */
#fullday-bridge{display:none;position:fixed;inset:0;background:rgba(10,14,26,.96);z-index:200;flex-direction:column;align-items:center;justify-content:center;text-align:center;gap:.4rem;padding:2rem}
#fullday-bridge.show{display:flex}
/* Personal best badge */
.pb-badge{display:inline-block;padding:.2rem .65rem;border-radius:99px;font-size:.75rem;font-weight:700;background:rgba(251,191,36,.15);color:#fbbf24;border:1px solid rgba(251,191,36,.3);margin-top:.5rem}
.mode-emoji{font-size:2.2rem}
.mode-label{font-weight:700;font-size:.95rem}
.mode-sub{font-size:.72rem;color:var(--muted);text-align:center}

/* â”€â”€ SHARED GAME CHROME â”€â”€ */
.screen{display:none;max-width:700px;margin:0 auto;padding:1rem 1rem 3rem}
.screen.show{display:block}
.topbar{display:flex;align-items:center;gap:.75rem;margin-bottom:1rem;flex-wrap:wrap}
.back-btn{padding:.4rem .8rem;background:transparent;border:1px solid var(--border);color:var(--muted);border-radius:6px;cursor:pointer;font-size:.82rem;transition:all .2s}
.back-btn:hover{border-color:var(--accent);color:var(--text)}
.cat-tag{font-weight:700;font-size:.95rem}
.cat-tag.de{color:var(--de)}.cat-tag.world{color:var(--world)}.cat-tag.collage{color:#a78bfa}.cat-tag.history{color:var(--history)}
.score-hud{margin-left:auto;font-size:.95rem;font-weight:600;color:var(--accent)}
.pips{display:flex;gap:5px}
.pip{width:22px;height:5px;border-radius:3px;background:var(--border);transition:background .3s}
.pip.ok{background:var(--green)}.pip.fail{background:var(--red)}.pip.timeout{background:#f59e0b}

/* â”€â”€ QUIZ ROUND â”€â”€ */
#quiz-round{}
.round-info{text-align:right;font-size:.78rem;color:var(--muted);margin-bottom:.4rem}
/* Art style badge for History mode */
.art-style-badge{
  position:absolute;bottom:8px;right:8px;
  padding:.18rem .55rem;border-radius:99px;
  font-size:.7rem;font-weight:700;
  background:rgba(245,158,11,.85);color:#0a0e1a;
  backdrop-filter:blur(4px);pointer-events:none;
}

/* Countdown bar */
.countdown-wrap{height:5px;background:var(--border);border-radius:3px;margin-bottom:1rem;overflow:hidden}
.countdown-bar{height:100%;border-radius:3px;width:100%;transition:width linear;background:var(--accent)}
.countdown-bar.urgent{background:var(--red)}

/* Image */
.quiz-img-wrap{border-radius:14px;overflow:hidden;border:2px solid var(--border);margin-bottom:1rem;position:relative}
.quiz-img-wrap img{width:100%;display:block;max-height:min(72vw,660px);object-fit:contain}
.img-result-overlay{
  position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
  font-size:3rem;opacity:0;transition:opacity .2s;pointer-events:none;
  background:rgba(0,0,0,.5);backdrop-filter:blur(2px)
}

/* Options */
.options{display:flex;flex-direction:column;gap:.55rem}
.opt{
  background:var(--card);border:2px solid var(--border);border-radius:10px;
  padding:.75rem 1rem;text-align:left;color:var(--text);
  cursor:pointer;font-size:.875rem;line-height:1.4;transition:all .18s;
  display:flex;align-items:flex-start;gap:.6rem
}
.opt:hover:not(:disabled){border-color:var(--accent);background:#1a2235}
.opt:disabled{cursor:default}
.opt.chosen{border-color:var(--accent);background:#0d2040}
.opt.correct{border-color:var(--green)!important;background:#052e16!important}
.opt.wrong{border-color:var(--red)!important;background:#2a0a0a!important}
.opt-bullet{width:22px;height:22px;min-width:22px;border-radius:50%;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:.75rem;margin-top:.1rem;transition:all .2s;font-weight:700}
.opt.chosen .opt-bullet{background:var(--accent);border-color:var(--accent);color:#0a0e1a}
.opt.correct .opt-bullet{background:var(--green);border-color:var(--green);color:#fff}
.opt.wrong   .opt-bullet{background:var(--red);border-color:var(--red);color:#fff}
.opt-text{}
.opt-src{font-size:.7rem;color:var(--muted);margin-top:.2rem}

/* â”€â”€ COLLAGE PICKER â”€â”€ */
#collage-picker{}
.style-grid{display:grid;grid-template-columns:1fr 1fr;gap:.75rem;margin-top:1rem}
@media(max-width:480px){.style-grid{grid-template-columns:1fr}}
.style-card{
  display:flex;flex-direction:column;align-items:center;gap:.4rem;
  padding:1rem;border-radius:12px;cursor:pointer;border:2px solid var(--border);
  background:var(--card);transition:all .22s;color:var(--text)
}
.style-card.bosch{border-color:#c084fc}.style-card.bosch:hover{background:#1a0f2a}
.style-card.vangogh{border-color:#fbbf24}.style-card.vangogh:hover{background:#1a1500}
.style-emoji{font-size:1.8rem}
.style-name{font-weight:700;font-size:.9rem}
.style-sub{font-size:.72rem;color:var(--muted)}

/* â”€â”€ COLLAGE GAME â”€â”€ */
#collage-game{max-width:min(90vw,1700px);margin:0 auto;padding-left:0;padding-right:0}
.collage-layout{display:flex;flex-direction:column;gap:1.25rem;align-items:center}
.collage-img-box{overflow:hidden;border:2px solid var(--border);border-radius:12px;position:relative;width:100%}
.collage-img-box img{width:100%;display:block}
.collage-opts-wrap{width:100%;max-width:860px;padding:0 1rem}
@media(max-width:620px){.collage-opts-wrap{padding:0 .75rem}}
.art-tag{position:absolute;top:8px;left:8px;padding:.2rem .6rem;border-radius:99px;font-size:.72rem;font-weight:700;backdrop-filter:blur(6px)}
.art-tag.bosch{background:rgba(192,132,252,.85);color:#fff}
.art-tag.vangogh{background:rgba(251,191,36,.9);color:#1a1000}
.collage-opts{display:flex;flex-direction:column;gap:.5rem}
.collage-hud-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:.3rem;font-size:.8rem;color:var(--muted)}
.chosen-count{font-weight:700;color:var(--accent)}
.check-btn{width:100%;padding:.7rem;background:var(--accent);color:#0a0e1a;border:none;border-radius:8px;font-size:.9rem;font-weight:700;cursor:pointer;transition:opacity .2s;margin-top:.4rem}
.check-btn:disabled{background:var(--border);color:var(--muted);cursor:not-allowed}
.check-btn:not(:disabled):hover{opacity:.85}
.copt{background:var(--card);border:2px solid var(--border);border-radius:9px;padding:.65rem .9rem;text-align:left;color:var(--text);cursor:pointer;font-size:.82rem;line-height:1.4;transition:all .18s;display:flex;align-items:flex-start;gap:.5rem}
.copt:hover:not(:disabled):not(.locked){border-color:var(--accent);background:#1a2235}
.copt.chosen{border-color:var(--accent);background:#0d2040}
.copt.correct{border-color:var(--green);background:#052e16;pointer-events:none}
.copt.wrong-sel{border-color:var(--red);background:#2a0a0a}
.copt.revealed{border-color:var(--green);background:#031a0d;opacity:.65;pointer-events:none}
.copt.locked{opacity:.4;pointer-events:none}
.copt-check{width:19px;height:19px;min-width:19px;border-radius:50%;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:.7rem;margin-top:.1rem;font-weight:700}
.copt.chosen .copt-check{background:var(--accent);border-color:var(--accent);color:#0a0e1a}
.copt.correct .copt-check{background:var(--green);border-color:var(--green);color:#fff}
.copt.wrong-sel .copt-check{background:var(--red);border-color:var(--red);color:#fff}
.copt.revealed .copt-check{background:var(--green);border-color:var(--green);color:#fff}
.copt-src{font-size:.68rem;color:var(--muted);margin-top:.15rem}

/* â”€â”€ RESULT â”€â”€ */
.result-screen{display:none;text-align:center;padding:2.5rem 1rem}
.result-screen.show{display:block}
.result-emoji{font-size:3.5rem;margin-bottom:.6rem}
.result-screen h2{font-size:1.6rem;color:var(--accent);margin-bottom:.4rem}
.result-screen p{color:var(--muted);margin-bottom:1.5rem}
.result-btns{display:flex;gap:.75rem;justify-content:center;flex-wrap:wrap}
.btn{padding:.65rem 1.5rem;border-radius:8px;font-size:.9rem;font-weight:700;cursor:pointer;border:none;transition:opacity .2s}
.btn-primary{background:var(--accent);color:#0a0e1a}.btn-secondary{background:var(--border);color:var(--text)}
.btn:hover{opacity:.85}

/* â”€â”€ QUIZ SUMMARY â”€â”€ */
.summary-card{background:var(--card);border:2px solid var(--border);border-radius:12px;padding:1rem;display:flex;gap:1rem;align-items:flex-start;transition:all .2s}
.summary-card.correct{border-color:var(--green);background:rgba(34,197,94,.05)}
.summary-card.wrong{border-color:var(--red);background:rgba(239,68,68,.05)}
.summary-card.timeout{border-color:#f59e0b;background:rgba(245,158,11,.05)}
.summary-thumb{min-width:150px;max-width:150px;border-radius:8px;overflow:hidden;border:1px solid var(--border);cursor:pointer;transition:transform .2s}
.summary-thumb:hover{transform:scale(1.05)}
.summary-thumb img{width:100%;display:block;object-fit:cover}
.summary-content{flex:1}
.summary-status{font-size:1.8rem;margin-bottom:.4rem}
.summary-headline{font-size:.95rem;font-weight:600;margin-bottom:.5rem;line-height:1.3}
.summary-answer{font-size:.85rem;margin-top:.35rem;line-height:1.4}
.summary-answer strong{font-weight:700}
.summary-answer.user-wrong{color:var(--red)}
.summary-answer.user-correct{color:var(--green)}
.summary-answer.timeout-text{color:#f59e0b}
@media(max-width:600px){.summary-card{flex-direction:column}.summary-thumb{max-width:100%;min-width:100%}}

@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}

/* â”€â”€ ARCHIVE â”€â”€ */
.archive-btn-wrap{max-width:600px;margin:.75rem auto 0;padding:0 1rem}
.archive-btn{width:100%;padding:.75rem 1rem;background:var(--card);border:1px solid var(--border);color:var(--muted);border-radius:10px;cursor:pointer;font-size:.875rem;transition:all .2s;text-align:left}
.archive-btn:hover{border-color:var(--accent);color:var(--text)}
.archive-list{display:flex;flex-direction:column;gap:.55rem;margin-top:.75rem}
.archive-item{background:var(--card);border:2px solid var(--border);border-radius:10px;padding:.85rem 1rem;cursor:pointer;color:var(--text);font-size:.9rem;font-weight:600;text-align:left;transition:all .2s;display:flex;justify-content:space-between;align-items:center;width:100%}
.archive-item:hover{border-color:var(--accent);background:#111827}
.archive-item.today-item{border-color:var(--accent)}
.ai-modes{font-size:.8rem;color:var(--muted)}
.today-pill{background:var(--accent);color:#0a0e1a;font-size:.7rem;font-weight:700;padding:.15rem .55rem;border-radius:99px}
.archive-empty{color:var(--muted);padding:.5rem 0;font-size:.875rem}
.archive-mode-banner{background:#1a2a1a;border:1px solid var(--green);border-radius:8px;padding:.5rem 1rem;text-align:center;font-size:.8rem;color:var(--green);max-width:600px;margin:.5rem auto 0;display:none}
.archive-mode-banner.show{display:block}

/* â”€â”€ SCORE WIDGET â”€â”€ */
#score-widget{
  display:flex;gap:.65rem;justify-content:center;flex-wrap:wrap;
  max-width:600px;margin:.75rem auto 0;padding:0 1rem;
}
.sw-item{
  flex:1;min-width:88px;background:var(--card);border:1px solid var(--border);
  border-radius:10px;padding:.6rem .75rem;text-align:center;
}
.sw-val{display:block;font-size:1rem;font-weight:700;color:var(--accent);line-height:1.25}
.sw-label{font-size:.7rem;color:var(--muted);margin-top:.18rem;display:block}

/* â”€â”€ MOBILE: HIDE HEADER/MENU WHEN QUIZ ACTIVE â”€â”€ */
@media(max-width:768px) {
  body.quiz-active header { display: none; }
  body.quiz-active #menu { display: none; }
}
</style>
</head>
<body>

<header>
  <h1>ğŸ“° News Quiz</h1>
  <p>Match headlines to images â€” beat the clock</p>
  <span class="date-badge" id="date-badge">Loadingâ€¦</span>
</header>

<!-- SCORE WIDGET (shown on home screen) -->
<div id="score-widget">
  <div class="sw-item">
    <span class="sw-val" id="sw-today">0/20 pts</span>
    <span class="sw-label">Today</span>
  </div>
  <div class="sw-item">
    <span class="sw-val" id="sw-best">ğŸ† 0 pts</span>
    <span class="sw-label">Best day</span>
  </div>
  <div class="sw-item">
    <span class="sw-val" id="sw-streak">ğŸ”¥ 0 days</span>
    <span class="sw-label">Streak</span>
  </div>
</div>

<!-- MAIN MENU -->
<div id="menu">
  <div class="menu-title">Choose a mode</div>
  <div class="menu-grid">
    <div class="mode-btn de" onclick="startQuiz('germany')">
      <div class="mode-emoji">ğŸ‡©ğŸ‡ª</div>
      <div class="mode-label">Germany</div>
      <div class="mode-sub">Deutsche News Â· Countdown</div>
    </div>
    <div class="mode-btn world" onclick="startQuiz('world')">
      <div class="mode-emoji">ğŸŒ</div>
      <div class="mode-label">World</div>
      <div class="mode-sub">World News Â· Countdown</div>
    </div>
    <div class="mode-btn history" onclick="showHistoryPicker()">
      <div class="mode-emoji">ğŸ›ï¸</div>
      <div class="mode-label">History</div>
      <div class="mode-sub">200 ADâ€“heute Â· Random Style</div>
    </div>
    <div class="mode-btn collage" onclick="showCollagePicker()">
      <div class="mode-emoji">ğŸ–¼ï¸</div>
      <div class="mode-label">Collage</div>
      <div class="mode-sub">4 stories Â· 1 artwork</div>
    </div>
    <div class="mode-btn fullday" onclick="startFullDay()">
      <div class="mode-emoji">ğŸ®</div>
      <div class="mode-label">Full Day â€” Alle Kategorien in einer Session</div>
      <div class="mode-sub">Germany + World + History Â· 12 Fragen Â· Highscore</div>
    </div>
  </div>
  <div class="archive-btn-wrap">
    <button class="archive-btn" onclick="showArchive()">ğŸ“… Archiv â€” vergangene Tage nachspielen â†’</button>
  </div>
  <div class="archive-mode-banner" id="archive-banner"></div>
</div>

<!-- ARCHIVE SCREEN -->
<div class="screen" id="archive-screen">
  <div style="max-width:600px;margin:0 auto;padding:1rem 1rem 3rem">
    <div class="topbar">
      <button class="back-btn" onclick="goMenu()">â† Menu</button>
      <span class="cat-tag" style="color:var(--muted)">ğŸ“… Archiv</span>
    </div>
    <div id="archive-list"><div class="archive-empty">Loadingâ€¦</div></div>
  </div>
</div>

<!-- QUIZ SCREEN -->
<div class="screen" id="quiz-screen">
  <div class="topbar">
    <button class="back-btn" onclick="goMenu()">â† Menu</button>
    <span class="cat-tag" id="quiz-cat-tag"></span>
    <div class="score-hud"><span id="quiz-score">0</span>/4</div>
    <div class="pips" id="quiz-pips"></div>
  </div>
  <div class="round-info">Image <span id="round-num">1</span> of 4</div>
  <div class="countdown-wrap"><div class="countdown-bar" id="cdown-bar"></div></div>
  <div class="quiz-img-wrap">
    <img id="quiz-img" src="" alt="">
    <div class="img-result-overlay" id="img-overlay"></div>
  </div>
  <div class="options" id="options"></div>

  <!-- inline result -->
  <div class="result-screen" id="quiz-result">
    <div class="result-emoji" id="qr-emoji"></div>
    <h2 id="qr-title"></h2>
    <p id="qr-sub"></p>
    <div class="result-btns">
      <button class="btn btn-primary" onclick="showQuizSummary(answeredItems)" style="background:var(--green);display:none">ğŸ“‹ View Summary</button>
      <button class="btn btn-primary" id="qr-retry" onclick="retryQuiz()">ğŸ”„ Try Again</button>
      <button class="btn btn-secondary" onclick="goMenu()">â† Menu</button>
    </div>
    <br><a href="/" style="color:var(--muted);font-size:.8rem">â† Home</a>
  </div>
</div>

<!-- QUIZ SUMMARY SCREEN -->
<div class="screen" id="quiz-summary">
  <div class="topbar">
    <button class="back-btn" onclick="goMenu()">â† Menu</button>
    <span class="cat-tag" id="summary-cat-tag">ğŸ“‹ Quiz Summary</span>
  </div>
  <div id="summary-cards" style="display:flex;flex-direction:column;gap:1rem;margin-top:1rem"></div>
  <div class="result-btns" style="margin-top:2rem;justify-content:center;display:flex">
    <button class="btn btn-primary" onclick="retryQuiz()">ğŸ”„ Play Again</button>
    <button class="btn btn-secondary" onclick="goMenu()">ğŸ  Home</button>
  </div>
</div>

<!-- COLLAGE PICKER -->
<div class="screen" id="collage-picker">
  <div class="topbar">
    <button class="back-btn" onclick="goMenu()">â† Menu</button>
    <span class="cat-tag collage">ğŸ–¼ï¸ Collage</span>
  </div>
  <div style="color:var(--muted);font-size:.85rem;margin-bottom:.25rem">Pick a category &amp; art style:</div>
  <div class="style-grid">
    <div class="style-card bosch"   onclick="startCollage('germany','bosch')"><div class="style-emoji">ğŸ‡©ğŸ‡ªğŸ¨</div><div class="style-name">Germany</div><div class="style-sub">Hieronymus Bosch</div></div>
    <div class="style-card vangogh" onclick="startCollage('germany','vangogh')"><div class="style-emoji">ğŸ‡©ğŸ‡ªğŸŒ»</div><div class="style-name">Germany</div><div class="style-sub">Vincent van Gogh</div></div>
    <div class="style-card bosch"   onclick="startCollage('world','bosch')"><div class="style-emoji">ğŸŒğŸ¨</div><div class="style-name">World</div><div class="style-sub">Hieronymus Bosch</div></div>
    <div class="style-card vangogh" onclick="startCollage('world','vangogh')"><div class="style-emoji">ğŸŒğŸŒ»</div><div class="style-name">World</div><div class="style-sub">Vincent van Gogh</div></div>
  </div>
</div>

<!-- COLLAGE GAME -->
<div class="screen" id="collage-game">
  <div class="collage-opts-wrap">
    <div class="topbar">
      <button class="back-btn" onclick="showCollagePicker()">â† Styles</button>
      <span class="cat-tag collage" id="coll-tag"></span>
      <div class="score-hud">Found: <span id="coll-score">0</span>/4</div>
    </div>
    <p style="font-size:.82rem;color:var(--muted);margin-bottom:.75rem"><strong style="color:var(--text)">Collage Mode:</strong> All 4 stories are hidden in this artwork. Select the 4 correct headlines from the 8 options!</p>
  </div>
  <div class="collage-layout">
    <div class="collage-img-box">
      <img id="coll-img" src="" alt="Collage">
      <span class="art-tag" id="coll-art-tag"></span>
    </div>
    <div class="collage-opts-wrap">
      <div class="collage-opts">
        <div class="collage-hud-row">
          <span>Select 4 hidden stories:</span>
          <span class="chosen-count"><span id="coll-chosen">0</span>/4 selected</span>
        </div>
        <div id="coll-opts"></div>
        <button class="check-btn" id="coll-check" disabled onclick="checkCollage()">Check Answers</button>
      </div>
    </div>
  </div>
  <div class="result-screen" id="coll-result">
    <div class="result-emoji" id="cr-emoji"></div>
    <h2 id="cr-title"></h2>
    <p id="cr-sub"></p>
    <div class="result-btns">
      <button class="btn btn-primary" onclick="showQuizSummary(answeredItems)" style="background:var(--green);display:none">ğŸ“‹ View Summary</button>
      <button class="btn btn-primary" onclick="restartCollage()">ğŸ”„ Again</button>
      <button class="btn btn-secondary" onclick="showCollagePicker()">â† Styles</button>
    </div>
  </div>
</div>

<!-- HISTORY PICKER -->
<div class="screen" id="history-picker">
  <div class="topbar">
    <button class="back-btn" onclick="goMenu()">â† Menu</button>
    <span class="cat-tag history">ğŸ›ï¸ History</span>
  </div>
  <div style="color:var(--muted);font-size:.85rem;margin-bottom:.25rem">WÃ¤hle History-Modus:</div>
  <div class="style-grid" style="grid-template-columns:1fr 1fr 1fr">
    <div class="style-card" style="border-color:var(--history)" onclick="startQuiz('history')">
      <div class="style-emoji">ğŸ›ï¸</div>
      <div class="style-name">Event Guess</div>
      <div class="style-sub">Welches Ereignis ist abgebildet?</div>
    </div>
    <div class="style-card" style="border-color:#f97316" onclick="startYearGuess()">
      <div class="style-emoji">ğŸ—“ï¸</div>
      <div class="style-name">Year Guess</div>
      <div class="style-sub">Wann ist das passiert?</div>
    </div>
    <div class="style-card" style="border-color:var(--green)" onclick="startQuiz('onthisday')">
      <div class="style-emoji">ğŸ“…</div>
      <div class="style-name">On This Day</div>
      <div class="style-sub">Ereignisse vom 19. Februar</div>
    </div>
  </div>
</div>

<!-- YEAR GUESS SCREEN -->
<div class="screen" id="year-screen">
  <div class="topbar">
    <button class="back-btn" onclick="stopYearTimer();goMenu()">â† Menu</button>
    <span class="cat-tag history">ğŸ—“ï¸ Year Guess</span>
    <div class="score-hud"><span id="year-score">0</span>/4</div>
    <div class="pips" id="year-pips"></div>
  </div>
  <div class="round-info">Round <span id="year-round-num">1</span> of 4</div>
  <div class="countdown-wrap"><div class="countdown-bar" id="year-cdown-bar"></div></div>
  <div class="quiz-img-wrap">
    <img id="year-img" src="" alt="">
    <div class="img-result-overlay" id="year-overlay"></div>
    <div class="art-style-badge" id="year-art-badge"></div>
  </div>
  <div class="year-event-label" id="year-event-name"></div>
  <div id="year-opts-wrap">
    <div style="font-size:.78rem;color:var(--muted);margin-bottom:.4rem">ğŸ“… Wann ist das passiert?</div>
    <div class="options" id="year-opts"></div>
  </div>
  <div class="result-screen" id="year-result">
    <div class="result-emoji" id="yr-emoji"></div>
    <h2 id="yr-title"></h2>
    <p id="yr-sub"></p>
    <div class="pb-badge" id="yr-pb" style="display:none"></div>
    <div class="result-btns" style="margin-top:1rem">
      <button class="btn btn-primary" onclick="showQuizSummary(answeredItems)" style="background:var(--green);display:none">ğŸ“‹ View Summary</button>
      <button class="btn btn-primary" onclick="startYearGuess()">ğŸ”„ Again</button>
      <button class="btn btn-secondary" onclick="showHistoryPicker()">â† History</button>
      <button class="btn btn-secondary" onclick="goMenu()">ğŸ  Menu</button>
    </div>
  </div>
</div>

<!-- FULL DAY RESULT SCREEN -->
<div class="screen" id="fullday-result">
  <div style="text-align:center;padding:2.5rem 1rem 3rem">
    <div class="result-emoji" id="fd-emoji">ğŸ†</div>
    <h2 style="font-size:1.6rem;color:var(--accent);margin:.4rem 0">Full Day abgeschlossen!</h2>
    <div id="fd-total" style="font-size:3.5rem;font-weight:800;color:var(--green);line-height:1.1;margin:.4rem 0"></div>
    <div style="color:var(--muted);font-size:.85rem;margin-bottom:1.25rem">Gesamt-Score</div>
    <div style="display:flex;flex-direction:column;gap:.5rem;max-width:320px;margin:0 auto 1.5rem">
      <div id="fd-germany" style="background:var(--card);padding:.65rem 1rem;border-radius:8px;border:1px solid var(--border);text-align:left"></div>
      <div id="fd-world"   style="background:var(--card);padding:.65rem 1rem;border-radius:8px;border:1px solid var(--border);text-align:left"></div>
      <div id="fd-history" style="background:var(--card);padding:.65rem 1rem;border-radius:8px;border:1px solid var(--border);text-align:left"></div>
    </div>
    <div class="pb-badge" id="fd-pb" style="display:none;margin-bottom:1rem"></div>
    <div class="result-btns">
      <button class="btn btn-primary" onclick="startFullDay()">ğŸ”„ Full Day nochmal</button>
      <button class="btn btn-secondary" onclick="goMenu()">â† Menu</button>
    </div>
  </div>
</div>

<!-- FULL DAY BRIDGE OVERLAY (between categories) -->
<div id="fullday-bridge">
  <div style="font-size:2.5rem">âœ…</div>
  <div id="bridge-cat" style="font-size:1.1rem;font-weight:700;color:var(--accent);margin:.2rem 0"></div>
  <div id="bridge-score" style="font-size:3rem;font-weight:800;color:var(--green)"></div>
  <div style="color:var(--muted);font-size:.85rem;margin-top:.5rem">NÃ¤chste Kategorie in KÃ¼rzeâ€¦</div>
</div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// GLOBALS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let Q = null; // quiz-data.json
let currentCat = null, currentStyle = null;
let answeredItems = []; // Track user answers for summary

function shuffle(a){const b=[...a];for(let i=b.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[b[i],b[j]]=[b[j],b[i]]}return b}

function show(id){document.querySelectorAll('.screen,#menu').forEach(e=>e.classList.remove('show'));const el=document.getElementById(id);if(el.id==='menu'){el.style.display='';document.body.classList.remove('quiz-active')}else{el.classList.add('show');document.body.classList.add('quiz-active')}window.scrollTo({top:0,behavior:'smooth'})}
function goMenu(){stopTimer();stopYearTimer();_fullDayMode=false;show('menu');updateScoreWidget()}

async function init(){
  Q=await(await fetch('quiz-data.json?t='+Date.now())).json();
  const d=new Date(Q.date+'T00:00:00');
  document.getElementById('date-badge').textContent=d.toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'});
  updateScoreWidget();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// QUIZ MODE (countdown, one image at a time)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TIMER_SEC = 15;
let quizRounds=[], quizIdx=0, quizScore=0, quizTimerRAF=null, timerStart=0;

function startQuiz(cat){
  currentCat=cat;
  quizScore=0; quizIdx=0;
  answeredItems = []; // Reset summary tracking

  // Build rounds: 4 images, each with 1 correct + 3 distractors â€” ALL from same category
  const correct = (cat === 'onthisday') ? Q.onthisday.events : Q.categories[cat];       // 4 items with images
  const otherCatMap = {germany:'world', world:'germany', history:'world', onthisday:'onthisday'};
  const otherCat = otherCatMap[cat] || 'world';
  const dPool   = (cat === 'onthisday' && Q.onthisday.distractors) ? Q.onthisday.distractors : 
                  ((Q.distractors && Q.distractors[cat]) ? Q.distractors[cat] : Q.categories[otherCat]);
  const shuffledCorrect = shuffle(correct);

  quizRounds = shuffledCorrect.map(item=>{
    // wrong pool = the other 3 correct headlines + all 4 distractors = 7 options
    const otherCorrect = correct.filter(c=>c.id!==item.id).map(c=>({...c,isCorrect:false}));
    const allWrong = shuffle([...otherCorrect,...dPool.map(d=>({...d,isCorrect:false}))]);
    const distractors = allWrong.slice(0,3);
    const opts = shuffle([{...item,isCorrect:true},...distractors]);
    return {item, opts};
  });

  // Build pip row
  const pips=document.getElementById('quiz-pips');
  pips.innerHTML='';
  for(let i=0;i<4;i++){const p=document.createElement('div');p.className='pip';pips.appendChild(p)}

  const catLabels={germany:'ğŸ‡©ğŸ‡ª Germany', world:'ğŸŒ World', history:'ğŸ›ï¸ History', onthisday:'ğŸ“… On This Day'};
  document.getElementById('quiz-cat-tag').textContent=catLabels[cat]||cat;
  document.getElementById('quiz-cat-tag').className='cat-tag '+cat;
  document.getElementById('quiz-score').textContent='0';
  document.getElementById('quiz-result').classList.remove('show');
  document.getElementById('options').style.display='';
  document.getElementById('quiz-img-wrap')&&(document.querySelector('.quiz-img-wrap').style.display='');

  show('quiz-screen');
  showRound();
}

function retryQuiz(){startQuiz(currentCat)}

function showRound(){
  if(quizIdx>=quizRounds.length){showQuizResult();return}
  const r=quizRounds[quizIdx];
  document.getElementById('round-num').textContent=quizIdx+1;
  document.getElementById('quiz-img').src=r.item.image;
  document.getElementById('img-overlay').style.opacity='0';
  document.getElementById('img-overlay').textContent='';
  // Show/update art style badge for History mode
  let badge=document.getElementById('art-style-badge');
  if((currentCat==='history' || currentCat==='onthisday') && r.item.style){
    if(!badge){badge=document.createElement('div');badge.id='art-style-badge';badge.className='art-style-badge';document.querySelector('.quiz-img-wrap').appendChild(badge)}
    badge.textContent='ğŸ¨ '+r.item.style;badge.style.display='';
  } else { if(badge) badge.style.display='none'; }

  const optsEl=document.getElementById('options');
  optsEl.innerHTML='';
  const letters=['A','B','C','D'];
  r.opts.forEach((opt,i)=>{
    const btn=document.createElement('button');
    btn.className='opt';
    btn.innerHTML=`<span class="opt-bullet">${letters[i]}</span><span><span class="opt-text">${opt.headline}</span><div class="opt-src">${opt.source}</div></span>`;
    btn.addEventListener('click',()=>pickOpt(opt.isCorrect,btn,r));
    optsEl.appendChild(btn);
  });

  startTimer();
}

// Timer
function startTimer(){
  stopTimer();
  const bar=document.getElementById('cdown-bar');
  bar.style.transition='none'; bar.style.width='100%'; bar.className='countdown-bar';
  timerStart=performance.now();

  function tick(now){
    const elapsed=(now-timerStart)/1000;
    const remaining=Math.max(0,1-elapsed/TIMER_SEC);
    bar.style.transition=`width ${1/60}s linear`;
    bar.style.width=(remaining*100)+'%';
    if(remaining<0.3) bar.className='countdown-bar urgent';
    if(remaining<=0){timeout();return}
    quizTimerRAF=requestAnimationFrame(tick);
  }
  quizTimerRAF=requestAnimationFrame(tick);
}

function stopTimer(){if(quizTimerRAF){cancelAnimationFrame(quizTimerRAF);quizTimerRAF=null}}

function timeout(){
  stopTimer();
  // mark all wrong (no answer)
  document.querySelectorAll('.opt').forEach(b=>{b.disabled=true});
  // reveal correct
  revealCorrect(quizRounds[quizIdx]);
  updatePip('timeout');
  const overlay=document.getElementById('img-overlay');
  overlay.textContent='â±ï¸'; overlay.style.opacity='1';
  
  // Track timeout for summary
  const round = quizRounds[quizIdx];
  answeredItems.push({
    id: round.item.id,
    headline: round.item.headline,
    image: round.item.image,
    userAnswer: 'â±ï¸ Timeout',
    correctAnswer: round.item.headline,
    correct: false,
    timeout: true
  });
  
  setTimeout(nextRound,1400);
}

function pickOpt(isCorrect, btn, round){
  stopTimer();
  
  // Get the selected headline before modifying the button
  const selectedHeadline = btn.querySelector('.opt-text').textContent;
  
  document.querySelectorAll('.opt').forEach(b=>b.disabled=true);
  btn.classList.add(isCorrect?'correct':'wrong');
  btn.querySelector('.opt-bullet').textContent=isCorrect?'âœ“':'âœ—';
  if(!isCorrect) revealCorrect(round);

  const overlay=document.getElementById('img-overlay');
  overlay.textContent=isCorrect?'âœ…':'âŒ'; overlay.style.opacity='1';

  updatePip(isCorrect?'ok':'fail');
  if(isCorrect){quizScore++;document.getElementById('quiz-score').textContent=quizScore}
  
  // Track answer for summary
  answeredItems.push({
    id: round.item.id,
    headline: round.item.headline,
    image: round.item.image,
    userAnswer: selectedHeadline,
    correctAnswer: round.item.headline,
    correct: isCorrect,
    timeout: false
  });
  
  setTimeout(nextRound,1400);
}

function revealCorrect(round){
  document.querySelectorAll('.opt').forEach((btn,i)=>{
    if(round.opts[i].isCorrect){btn.classList.add('correct');btn.querySelector('.opt-bullet').textContent='âœ“'}
  });
}

function updatePip(status){
  const pip=document.querySelectorAll('#quiz-pips .pip')[quizIdx];
  if(pip) pip.classList.add(status);
}

function nextRound(){quizIdx++;showRound()}

function showQuizResult(){
  document.getElementById('options').style.display='none';
  document.querySelector('.quiz-img-wrap').style.display='none';
  document.querySelector('.countdown-wrap').style.display='none';
  const screen=document.getElementById('quiz-result');
  screen.classList.add('show');
  const s=quizScore;
  const emojis=['ğŸ˜µ','ğŸ˜…','ğŸ¤”','ğŸ‘','ğŸ†'];
  const titles=['Tough one!','Getting there!','Solid!','Almost perfect!','Perfect!'];
  const subs=['The news was tricky today.','Keep watching the headlines.','You know your stuff!','Just one slipped by!','You nailed every headline!'];
  document.getElementById('qr-emoji').textContent=emojis[s];
  document.getElementById('qr-title').textContent=titles[s];
  document.getElementById('qr-sub').textContent=`${s}/4 correct. ${subs[s]}`;
  saveScore(currentCat, s);
  // Record daily score for widget
  const _modeKey = currentCat==='germany'?'de': currentCat==='world'?'world': currentCat==='history'?'history': null;
  if(_modeKey) recordScore(_modeKey, s);
  // reset hidden elements for next time
  setTimeout(()=>{
    document.querySelector('.quiz-img-wrap').style.display='';
    document.querySelector('.countdown-wrap').style.display='';
  },100);
  // Full Day chaining
  if(_fullDayMode){ setTimeout(()=>advanceFullDay(currentCat,s), 2400); }
  // Auto-show summary after 2 seconds
  else{ setTimeout(()=>showQuizSummary(answeredItems), 2000); }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// QUIZ SUMMARY SCREEN
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showQuizSummary(items){
  if(!items || items.length === 0) return;
  
  const summaryCards = document.getElementById('summary-cards');
  summaryCards.innerHTML = '';
  
  // Add score header
  const correctCount = items.filter(i => i.correct).length;
  const totalCount = items.length;
  const scoreHeader = document.createElement('div');
  scoreHeader.style.cssText = 'text-align:center;margin-bottom:1.5rem;padding:1rem;background:var(--card);border:2px solid var(--border);border-radius:12px';
  scoreHeader.innerHTML = `
    <div style="font-size:2.5rem;font-weight:800;color:var(--accent);margin-bottom:.25rem">${correctCount}/${totalCount}</div>
    <div style="font-size:.9rem;color:var(--muted)">Questions Correct</div>
  `;
  summaryCards.appendChild(scoreHeader);
  
  items.forEach((item, index) => {
    const card = document.createElement('div');
    const cardClass = item.timeout ? 'timeout' : (item.correct ? 'correct' : 'wrong');
    const statusEmoji = item.timeout ? 'â±ï¸' : (item.correct ? 'âœ…' : 'âŒ');
    
    card.className = `summary-card ${cardClass}`;
    card.innerHTML = `
      <div class="summary-thumb" onclick="window.open('${item.image}', '_blank')">
        <img src="${item.image}" alt="Question ${index+1}">
      </div>
      <div class="summary-content">
        <div class="summary-status">${statusEmoji}</div>
        <div class="summary-headline">${item.headline}</div>
        ${!item.correct ? `
          <div class="summary-answer user-wrong">
            <strong>Your answer:</strong> ${item.userAnswer}
          </div>
        ` : ''}
        <div class="summary-answer ${item.correct ? 'user-correct' : ''}">
          <strong>Correct answer:</strong> ${item.correctAnswer}
        </div>
      </div>
    `;
    summaryCards.appendChild(card);
  });
  
  // Update category tag
  const catLabels = {
    germany:'ğŸ‡©ğŸ‡ª Germany', 
    world:'ğŸŒ World', 
    history:'ğŸ›ï¸ History', 
    yearguess:'ğŸ—“ï¸ Year Guess'
  };
  
  // Handle collage mode - determine if it was germany or world collage
  let displayCat = currentCat;
  if(items.length === 4) {
    // Regular quiz mode (4 items) - use currentCat
    displayCat = currentCat;
  } else if(currentStyle) {
    // Collage mode - use 'collage' as display category
    displayCat = 'collage';
    catLabels.collage = 'ğŸ–¼ï¸ Collage';
  }
  
  const catTag = document.getElementById('summary-cat-tag');
  catTag.textContent = `ğŸ“‹ ${catLabels[displayCat] || 'Quiz'} Summary`;
  catTag.className = 'cat-tag ' + displayCat;
  
  show('quiz-summary');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// COLLAGE MODE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let collageChosen=new Set(), collageChecked=false;

function showCollagePicker(){
  stopTimer();
  // Grey out style cards for collages that aren't available today
  document.querySelectorAll('#collage-picker .style-card').forEach(card=>{
    const onclick=card.getAttribute('onclick')||'';
    const m=onclick.match(/startCollage\('(\w+)','(\w+)'\)/);
    if(m){
      const available=Q.collages?.[m[1]]?.[m[2]];
      card.style.opacity=available?'':'0.35';
      card.style.pointerEvents=available?'':'none';
      card.title=available?'':'Not available today';
    }
  });
  show('collage-picker');
}

function startCollage(cat,style){
  const info=Q.collages?.[cat]?.[style];
  if(!info){alert('Diese Collage ist heute leider nicht verfÃ¼gbar. Bitte wÃ¤hle eine andere!');return;}
  currentCat=cat; currentStyle=style;
  collageChosen=new Set(); collageChecked=false;
  answeredItems = []; // Reset summary tracking

  document.getElementById('coll-img').src=info.image;
  const artTag=document.getElementById('coll-art-tag');
  artTag.textContent=info.style; artTag.className='art-tag '+style;
  document.getElementById('coll-tag').textContent=(cat==='germany'?'ğŸ‡©ğŸ‡ª Germany':'ğŸŒ World')+' Â· '+info.style;
  document.getElementById('coll-score').textContent='0';
  document.getElementById('coll-chosen').textContent='0';
  document.getElementById('coll-check').disabled=true;
  document.getElementById('coll-result').classList.remove('show');
  document.querySelector('.collage-layout').style.display='';

  // Collage: 4 correct (with images) + 4 distractors = 8 options
  const correct=Q.categories[cat];
  const otherCatC=cat==='germany'?'world':'germany';
  const distractors=Q.distractors?.[cat] ?? Q.categories[otherCatC];
  const allOpts=shuffle([...correct.map(i=>({...i,isCorrect:true})),...distractors.map(i=>({...i,isCorrect:false}))]);

  const optsEl=document.getElementById('coll-opts');
  optsEl.innerHTML='';
  allOpts.forEach(item=>{
    const btn=document.createElement('button');
    btn.className='copt'; btn.dataset.id=item.id; btn.dataset.correct=item.isCorrect;
    btn.innerHTML=`<span class="copt-check"></span><span>${item.headline}<div class="copt-src">${item.source}</div></span>`;
    btn.addEventListener('click',()=>toggleCOpt(item.id,btn));
    optsEl.appendChild(btn);
  });

  show('collage-game');
}

function toggleCOpt(id,btn){
  if(collageChecked||btn.classList.contains('correct')||btn.classList.contains('revealed'))return;
  if(collageChosen.has(id)){
    collageChosen.delete(id); btn.classList.remove('chosen'); btn.querySelector('.copt-check').textContent='';
  } else {
    if(collageChosen.size>=4)return;
    collageChosen.add(id); btn.classList.add('chosen'); btn.querySelector('.copt-check').textContent='âœ“';
  }
  const n=collageChosen.size;
  document.getElementById('coll-chosen').textContent=n;
  document.getElementById('coll-check').disabled=n<4;
}

function checkCollage(){
  collageChecked=true;
  let score=0;
  const info=Q.collages?.[currentCat]?.[currentStyle];
  
  document.querySelectorAll('.copt').forEach(btn=>{
    const id=btn.dataset.id, isCorrect=btn.dataset.correct==='true', wasChosen=collageChosen.has(id);
    const headline = btn.querySelector('span:last-child').firstChild.textContent;
    
    // Track each item for summary
    if(isCorrect) {
      const correctItem = Q.categories[currentCat].find(item => item.id === id);
      answeredItems.push({
        id: id,
        headline: headline,
        image: correctItem?.image || info.image,
        userAnswer: wasChosen ? headline : '(Not selected)',
        correctAnswer: headline,
        correct: wasChosen,
        timeout: false
      });
    }
    
    if(wasChosen&&isCorrect){btn.classList.remove('chosen');btn.classList.add('correct');btn.querySelector('.copt-check').textContent='âœ“';score++}
    else if(wasChosen&&!isCorrect){btn.classList.remove('chosen');btn.classList.add('wrong-sel');btn.querySelector('.copt-check').textContent='âœ—'}
    else if(!wasChosen&&isCorrect){btn.classList.add('revealed');btn.querySelector('.copt-check').textContent='âœ“'}
    else btn.classList.add('locked');
  });
  document.getElementById('coll-score').textContent=score;
  document.getElementById('coll-check').disabled=true;
  setTimeout(()=>showCollageResult(score),600);
}

function showCollageResult(score){
  recordScore('collage', score);
  document.querySelector('.collage-layout').style.display='none';
  const screen=document.getElementById('coll-result'); screen.classList.add('show');
  const emojis=['ğŸ˜µ','ğŸ˜…','ğŸ¤”','ğŸ‘','ğŸ†'];
  const titles=['Completely stumped!','Getting warmer!','Good eye!','Almost!','Perfect eye!'];
  const subs=['The artist was sneaky.','Try a different style!','You spotted most of them!','One story slipped by!','You can read art like a newspaper!'];
  document.getElementById('cr-emoji').textContent=emojis[score];
  document.getElementById('cr-title').textContent=titles[score];
  document.getElementById('cr-sub').textContent=`${score}/4 stories found. ${subs[score]}`;
  // Auto-show summary after 2 seconds
  setTimeout(()=>showQuizSummary(answeredItems), 2000);
}
function restartCollage(){startCollage(currentCat,currentStyle)}

// â”€â”€ ARCHIVE â”€â”€
let originalQ = null;

async function showArchive() {
  show('archive-screen');
  const listEl = document.getElementById('archive-list');
  listEl.innerHTML = '<div class="archive-empty">Loadingâ€¦</div>';
  try {
    const index = await (await fetch('archive-index.json?t='+Date.now())).json();
    listEl.innerHTML = '';

    // Today's entry always first
    const todayBtn = document.createElement('button');
    todayBtn.className = 'archive-item today-item';
    const td = new Date((originalQ||Q).date+'T00:00:00');
    todayBtn.innerHTML = `<span>${td.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'})}</span><span class="today-pill">Today</span>`;
    todayBtn.onclick = loadTodayQuiz;
    listEl.appendChild(todayBtn);

    if (!index.length) {
      const note = document.createElement('div');
      note.className = 'archive-empty';
      note.textContent = 'No archived days yet â€” check back tomorrow!';
      listEl.appendChild(note);
      return;
    }
    index.forEach(date => {
      const d = new Date(date+'T00:00:00');
      const label = d.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'});
      const btn = document.createElement('button');
      btn.className = 'archive-item';
      btn.innerHTML = `<span>${label}</span><span class="ai-modes">ğŸ‡©ğŸ‡ª &nbsp;ğŸŒ &nbsp;ğŸ–¼ï¸</span>`;
      btn.onclick = () => loadArchivedQuiz(date);
      listEl.appendChild(btn);
    });
  } catch(e) {
    listEl.innerHTML = '<div class="archive-empty">No archive available yet â€” check back tomorrow!</div>';
  }
}

async function loadArchivedQuiz(date) {
  if (!originalQ) originalQ = Q;
  try {
    Q = await (await fetch(`quiz-data-${date}.json?t=`+Date.now())).json();
    const d = new Date(date+'T00:00:00');
    const label = d.toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'});
    document.getElementById('date-badge').textContent = 'ğŸ“… '+label;
    const banner = document.getElementById('archive-banner');
    banner.textContent = 'ğŸ“… Playing archive: '+label+' â€” ';
    const back = document.createElement('span');
    back.style.cssText = 'cursor:pointer;text-decoration:underline';
    back.textContent = 'back to today';
    back.onclick = loadTodayQuiz;
    banner.appendChild(back);
    banner.classList.add('show');
    goMenu();
  } catch(e) {
    alert('Could not load archive for '+date);
  }
}

function loadTodayQuiz() {
  if (originalQ) { Q = originalQ; originalQ = null; }
  const d = new Date(Q.date+'T00:00:00');
  document.getElementById('date-badge').textContent = d.toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'});
  document.getElementById('archive-banner').classList.remove('show');
  goMenu();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// HISTORY PICKER
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showHistoryPicker(){stopTimer();show('history-picker')}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// HIGHSCORE (localStorage)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveScore(mode,score){
  const today=Q?.date||new Date().toISOString().slice(0,10);
  let data={};
  try{data=JSON.parse(localStorage.getItem('newsquiz_scores')||'{}')}catch(e){}
  if(!data[today])data[today]={};
  const prev=data[today][mode]??0;
  const isNew=score>prev;
  if(isNew)data[today][mode]=score;
  localStorage.setItem('newsquiz_scores',JSON.stringify(data));
  return{score,prev,isNew};
}
function getBest(mode){
  const today=Q?.date||new Date().toISOString().slice(0,10);
  try{const d=JSON.parse(localStorage.getItem('newsquiz_scores')||'{}');return d[today]?.[mode]??null}catch(e){return null}
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// YEAR GUESS MODE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const YEAR_TIMER=15;
let yearRounds=[],yearIdx=0,yearScore=0,yearTimerRAF=null;

function startYearGuess(){
  currentCat='yearguess';
  yearScore=0;yearIdx=0;
  answeredItems = []; // Reset summary tracking
  const items=Q.categories.history||[];
  if(!items.length){alert('Noch keine History-Daten. Bitte zuerst das Gen-Script laufen lassen.');return}
  // Build year pool from all history items + distractors
  const allItems=[...items,...(Q.distractors?.history||[])];
  const yearPool=[...new Set(allItems.map(e=>e.year).filter(Boolean))];

  yearRounds=shuffle([...items]).map(item=>{
    let wrong=shuffle(yearPool.filter(y=>y!==item.year)).slice(0,3);
    // Pad with plausible offsets if pool too small
    const offsets=[57,113,182,231];
    let oi=0;
    while(wrong.length<3){
      const y=Math.max(200,Math.min(2010,item.year+(oi%2===0?1:-1)*offsets[oi]));
      if(!wrong.includes(y)&&y!==item.year)wrong.push(y);
      oi++;
    }
    return{item,opts:shuffle([item.year,...wrong.slice(0,3)])};
  });

  const pips=document.getElementById('year-pips');
  pips.innerHTML='';
  for(let i=0;i<4;i++){const p=document.createElement('div');p.className='pip';pips.appendChild(p)}
  document.getElementById('year-score').textContent='0';
  document.getElementById('year-result').classList.remove('show');
  document.getElementById('year-opts-wrap').style.display='';
  document.querySelector('#year-screen .quiz-img-wrap').style.display='';
  document.querySelector('#year-screen .countdown-wrap').style.display='';
  show('year-screen');
  showYearRound();
}

function showYearRound(){
  if(yearIdx>=yearRounds.length){showYearResult();return}
  const r=yearRounds[yearIdx];
  document.getElementById('year-round-num').textContent=yearIdx+1;
  document.getElementById('year-img').src=r.item.image;
  // Strip year from headline for year-guessing mode (e.g. "Fall of Rome (476 AD)" â†’ "Fall of Rome")
  const cleanHeadline = r.item.headline.replace(/\s*\(\d{3,4}\s*(AD|BC)?\)/g, '');
  document.getElementById('year-event-name').textContent=cleanHeadline;
  document.getElementById('year-art-badge').textContent=r.item.style?'ğŸ¨ '+r.item.style:'';
  document.getElementById('year-overlay').style.opacity='0';
  document.getElementById('year-overlay').textContent='';

  const optsEl=document.getElementById('year-opts');
  optsEl.innerHTML='';
  r.opts.forEach(year=>{
    const btn=document.createElement('button');
    btn.className='opt';
    const isCorrect=year===r.item.year;
    const label=year<1000?year+' AD':String(year);
    btn.innerHTML=`<span class="opt-bullet">ğŸ“…</span><span class="opt-text"><strong>${label}</strong></span>`;
    btn.addEventListener('click',()=>pickYearOpt(isCorrect,year,btn,r));
    optsEl.appendChild(btn);
  });
  startYearTimer();
}

function startYearTimer(){
  stopYearTimer();
  const bar=document.getElementById('year-cdown-bar');
  bar.style.transition='none';bar.style.width='100%';bar.className='countdown-bar';
  timerStart=performance.now();
  function tick(now){
    const elapsed=(now-timerStart)/1000;
    const rem=Math.max(0,1-elapsed/YEAR_TIMER);
    bar.style.transition=`width ${1/60}s linear`;
    bar.style.width=(rem*100)+'%';
    if(rem<0.3)bar.className='countdown-bar urgent';
    if(rem<=0){yearTimeout(yearRounds[yearIdx]);return}
    yearTimerRAF=requestAnimationFrame(tick);
  }
  yearTimerRAF=requestAnimationFrame(tick);
}
function stopYearTimer(){if(yearTimerRAF){cancelAnimationFrame(yearTimerRAF);yearTimerRAF=null}}

function yearTimeout(round){
  stopYearTimer();
  document.querySelectorAll('#year-opts .opt').forEach(b=>b.disabled=true);
  revealCorrectYear(round);
  const pip=document.querySelectorAll('#year-pips .pip')[yearIdx];
  if(pip)pip.classList.add('timeout');
  document.getElementById('year-overlay').textContent='â±ï¸';
  document.getElementById('year-overlay').style.opacity='1';
  
  // Track timeout for summary
  const correctLabel = round.item.year<1000 ? round.item.year+' AD' : String(round.item.year);
  answeredItems.push({
    id: round.item.id,
    headline: round.item.headline,
    image: round.item.image,
    userAnswer: 'â±ï¸ Timeout',
    correctAnswer: correctLabel,
    correct: false,
    timeout: true
  });
  
  setTimeout(()=>{yearIdx++;showYearRound()},1600);
}

function pickYearOpt(isCorrect,year,btn,round){
  stopYearTimer();
  document.querySelectorAll('#year-opts .opt').forEach(b=>b.disabled=true);
  btn.classList.add(isCorrect?'correct':'wrong');
  btn.querySelector('.opt-bullet').textContent=isCorrect?'âœ“':'âœ—';
  if(!isCorrect)revealCorrectYear(round);
  const overlay=document.getElementById('year-overlay');
  overlay.textContent=isCorrect?'âœ…':'âŒ';overlay.style.opacity='1';
  const pip=document.querySelectorAll('#year-pips .pip')[yearIdx];
  if(pip)pip.classList.add(isCorrect?'ok':'fail');
  if(isCorrect){yearScore++;document.getElementById('year-score').textContent=yearScore}
  
  // Track answer for summary
  const yearLabel = year<1000 ? year+' AD' : String(year);
  const correctLabel = round.item.year<1000 ? round.item.year+' AD' : String(round.item.year);
  answeredItems.push({
    id: round.item.id,
    headline: round.item.headline,
    image: round.item.image,
    userAnswer: yearLabel,
    correctAnswer: correctLabel,
    correct: isCorrect,
    timeout: false
  });
  
  setTimeout(()=>{yearIdx++;showYearRound()},1600);
}

function revealCorrectYear(round){
  document.querySelectorAll('#year-opts .opt').forEach((btn,i)=>{
    if(round.opts[i]===round.item.year){
      btn.classList.add('correct');
      btn.querySelector('.opt-bullet').textContent='âœ“';
    }
  });
}

function showYearResult(){
  document.getElementById('year-opts-wrap').style.display='none';
  document.querySelector('#year-screen .quiz-img-wrap').style.display='none';
  document.querySelector('#year-screen .countdown-wrap').style.display='none';
  document.getElementById('year-result').classList.add('show');
  const s=yearScore;
  const emojis=['ğŸ˜µ','ğŸ˜…','ğŸ¤”','ğŸ‘','ğŸ†'];
  const titles=['History ist brutal!','Kommt noch!','Ordentlicher Historiker!','Fast perfekt!','Zeitreisender!'];
  document.getElementById('yr-emoji').textContent=emojis[s];
  document.getElementById('yr-title').textContent=titles[s];
  document.getElementById('yr-sub').textContent=`${s}/4 Jahren richtig.`;
  const res=saveScore('yearguess',s);
  const pb=document.getElementById('yr-pb');
  if(res.isNew&&s>0){pb.textContent=`ğŸ† Neuer Highscore: ${s}/4!`;pb.style.display=''}
  else if(res.prev!==null){pb.textContent=`Bisheriges Bestes heute: ${res.prev}/4`;pb.style.display=''}
  setTimeout(()=>{
    document.querySelector('#year-screen .quiz-img-wrap').style.display='';
    document.querySelector('#year-screen .countdown-wrap').style.display='';
  },100);
  if(_fullDayMode){setTimeout(()=>advanceFullDay('yearguess',s),2400)}
  // Auto-show summary after 2 seconds (unless Full Day mode is active)
  else{setTimeout(()=>showQuizSummary(answeredItems), 2000)}
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// FULL DAY MODE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _fullDayMode=false,_fullDayCatQueue=[],_fullDayScores={};

function startFullDay(){
  _fullDayMode=true;
  _fullDayCatQueue=['germany','world','history'];
  _fullDayScores={};
  advanceFullDay(null,0);
}

function advanceFullDay(completedCat,score){
  if(completedCat)_fullDayScores[completedCat]=score;
  if(!_fullDayCatQueue.length){_fullDayMode=false;showFullDayResult();return}
  const next=_fullDayCatQueue.shift();
  if(completedCat){
    const bridge=document.getElementById('fullday-bridge');
    const catLabels={germany:'ğŸ‡©ğŸ‡ª Germany',world:'ğŸŒ World',history:'ğŸ›ï¸ History'};
    document.getElementById('bridge-cat').textContent=catLabels[completedCat]||completedCat;
    document.getElementById('bridge-score').textContent=`${score}/4`;
    bridge.classList.add('show');
    setTimeout(()=>{bridge.classList.remove('show');startQuiz(next)},2000);
  } else {
    startQuiz(next);
  }
}

function showFullDayResult(){
  const cats=['germany','world','history'];
  const labels={germany:'ğŸ‡©ğŸ‡ª Germany',world:'ğŸŒ World',history:'ğŸ›ï¸ History'};
  const total=cats.reduce((a,c)=>a+(_fullDayScores[c]||0),0);
  document.getElementById('fd-total').textContent=`${total}/12`;
  cats.forEach(c=>{
    const el=document.getElementById('fd-'+c);
    if(el)el.textContent=`${labels[c]}: ${_fullDayScores[c]??0}/4`;
  });
  const pct=total/12;
  const emojis=['ğŸ’€','ğŸ˜…','ğŸ¤”','ğŸ‘','ğŸ†'];
  document.getElementById('fd-emoji').textContent=emojis[Math.min(4,Math.round(pct*4))];
  const res=saveScore('fullday',total);
  const pb=document.getElementById('fd-pb');
  if(res.isNew&&total>0){pb.textContent=`ğŸ† Neuer Highscore: ${total}/12!`;pb.style.display='inline-block'}
  else if(res.prev!==null){pb.textContent=`Bisheriges Bestes heute: ${res.prev}/12`;pb.style.display='inline-block'}
  show('fullday-result');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DAILY SCORE SYSTEM  (key: quiz_scores)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SCORE_KEY = 'quiz_scores';
const MODE_MAX  = {de:4, world:4, history:4, collage:8};
const TOTAL_MAX = 20; // 4+4+4+8

function recordScore(mode, count){
  const today = Q?.date || new Date().toISOString().slice(0,10);
  let data = {};
  try{ data = JSON.parse(localStorage.getItem(SCORE_KEY)||'{}'); }catch(e){}
  if(!data[today]) data[today] = {};
  // Only overwrite with a better score
  const prev = data[today][mode] ?? -1;
  if(count > prev) data[today][mode] = count;
  localStorage.setItem(SCORE_KEY, JSON.stringify(data));
  updateScoreWidget();
}

function getScoreStats(){
  const today = Q?.date || new Date().toISOString().slice(0,10);
  let data = {};
  try{ data = JSON.parse(localStorage.getItem(SCORE_KEY)||'{}'); }catch(e){}
  const todayScores = data[today] || {};
  const todayTotal  = Object.values(todayScores).reduce((a,v)=>a+v, 0);

  // All-time best single-day total
  let highscore = 0;
  for(const day of Object.values(data)){
    const t = Object.values(day).reduce((a,v)=>a+v, 0);
    if(t > highscore) highscore = t;
  }

  // Streak: consecutive days ending today with â‰¥1 mode played
  const days = Object.keys(data).sort().reverse();
  let streak = 0;
  const todayMs = new Date(today).getTime();
  for(let i=0; i<days.length; i++){
    const diff = Math.round((todayMs - new Date(days[i]).getTime()) / 86400000);
    if(diff === i && Object.keys(data[days[i]]).length > 0) streak++;
    else break;
  }

  return{ todayTotal, highscore, streak };
}

function updateScoreWidget(){
  const el = document.getElementById('score-widget');
  if(!el) return;
  const { todayTotal, highscore, streak } = getScoreStats();
  document.getElementById('sw-today').textContent  = todayTotal + '/' + TOTAL_MAX + ' pts';
  document.getElementById('sw-best').textContent   = 'ğŸ† ' + highscore + ' pts';
  document.getElementById('sw-streak').textContent = 'ğŸ”¥ ' + streak + ' day' + (streak!==1?'s':'');
}

// â”€â”€ BOOT â”€â”€
init().catch(()=>{document.querySelector('header p').textContent='Failed to load quiz data.'});
</script>
</body>
</html>
