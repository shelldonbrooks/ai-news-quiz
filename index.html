<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üì∞ News Quiz</title>
<link rel="icon" type="image/svg+xml" href="/favicon.svg">
<style>
:root {
  --bg:#0a0e1a; --card:#111827; --border:#1f2937;
  --accent:#38bdf8; --green:#22c55e; --red:#ef4444;
  --text:#e2e8f0; --muted:#6b7280;
  --de:#e8c84a; --world:#38bdf8;
}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;min-height:100vh}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
header{text-align:center;padding:1.75rem 1rem 1rem;border-bottom:1px solid var(--border)}
header h1{font-size:1.8rem;margin-bottom:.25rem}
header p{color:var(--muted);font-size:.9rem}
.date-badge{display:inline-block;margin-top:.5rem;padding:.2rem .7rem;background:#1f2937;border-radius:99px;font-size:.78rem;color:var(--accent)}

/* ‚îÄ‚îÄ MAIN MENU ‚îÄ‚îÄ */
#menu{max-width:600px;margin:0 auto;padding:1.5rem 1rem}
.menu-title{text-align:center;font-size:.8rem;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;margin-bottom:1rem}
.menu-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:.9rem}
@media(max-width:480px){.menu-grid{grid-template-columns:1fr 1fr}}
.mode-btn{
  display:flex;flex-direction:column;align-items:center;gap:.4rem;
  padding:1.1rem .75rem;border-radius:14px;cursor:pointer;
  border:2px solid var(--border);background:var(--card);
  transition:all .22s;color:var(--text)
}
.mode-btn:hover{transform:translateY(-3px);box-shadow:0 8px 24px rgba(0,0,0,.4)}
.mode-btn.de{border-color:var(--de)}.mode-btn.de:hover{background:#1a1810}
.mode-btn.world{border-color:var(--world)}.mode-btn.world:hover{background:#0d1f2a}
.mode-btn.collage{border-color:#a78bfa}.mode-btn.collage:hover{background:#180f2a}
.mode-emoji{font-size:2.2rem}
.mode-label{font-weight:700;font-size:.95rem}
.mode-sub{font-size:.72rem;color:var(--muted);text-align:center}

/* ‚îÄ‚îÄ SHARED GAME CHROME ‚îÄ‚îÄ */
.screen{display:none;max-width:700px;margin:0 auto;padding:1rem 1rem 3rem}
.screen.show{display:block}
.topbar{display:flex;align-items:center;gap:.75rem;margin-bottom:1rem;flex-wrap:wrap}
.back-btn{padding:.4rem .8rem;background:transparent;border:1px solid var(--border);color:var(--muted);border-radius:6px;cursor:pointer;font-size:.82rem;transition:all .2s}
.back-btn:hover{border-color:var(--accent);color:var(--text)}
.cat-tag{font-weight:700;font-size:.95rem}
.cat-tag.de{color:var(--de)}.cat-tag.world{color:var(--world)}.cat-tag.collage{color:#a78bfa}
.score-hud{margin-left:auto;font-size:.95rem;font-weight:600;color:var(--accent)}
.pips{display:flex;gap:5px}
.pip{width:22px;height:5px;border-radius:3px;background:var(--border);transition:background .3s}
.pip.ok{background:var(--green)}.pip.fail{background:var(--red)}.pip.timeout{background:#f59e0b}

/* ‚îÄ‚îÄ QUIZ ROUND ‚îÄ‚îÄ */
#quiz-round{}
.round-info{text-align:right;font-size:.78rem;color:var(--muted);margin-bottom:.4rem}

/* Countdown bar */
.countdown-wrap{height:5px;background:var(--border);border-radius:3px;margin-bottom:1rem;overflow:hidden}
.countdown-bar{height:100%;border-radius:3px;width:100%;transition:width linear;background:var(--accent)}
.countdown-bar.urgent{background:var(--red)}

/* Image */
.quiz-img-wrap{border-radius:14px;overflow:hidden;border:2px solid var(--border);margin-bottom:1rem;position:relative}
.quiz-img-wrap img{width:100%;max-height:360px;object-fit:cover;display:block}
.img-result-overlay{
  position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
  font-size:3rem;opacity:0;transition:opacity .2s;pointer-events:none;
  background:rgba(0,0,0,.5);backdrop-filter:blur(2px)
}

/* Options */
.options{display:flex;flex-direction:column;gap:.55rem}
.opt{
  background:var(--card);border:2px solid var(--border);border-radius:10px;
  padding:.75rem 1rem;text-align:left;color:var(--text);
  cursor:pointer;font-size:.875rem;line-height:1.4;transition:all .18s;
  display:flex;align-items:flex-start;gap:.6rem
}
.opt:hover:not(:disabled){border-color:var(--accent);background:#1a2235}
.opt:disabled{cursor:default}
.opt.chosen{border-color:var(--accent);background:#0d2040}
.opt.correct{border-color:var(--green)!important;background:#052e16!important}
.opt.wrong{border-color:var(--red)!important;background:#2a0a0a!important}
.opt-bullet{width:22px;height:22px;min-width:22px;border-radius:50%;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:.75rem;margin-top:.1rem;transition:all .2s;font-weight:700}
.opt.chosen .opt-bullet{background:var(--accent);border-color:var(--accent);color:#0a0e1a}
.opt.correct .opt-bullet{background:var(--green);border-color:var(--green);color:#fff}
.opt.wrong   .opt-bullet{background:var(--red);border-color:var(--red);color:#fff}
.opt-text{}
.opt-src{font-size:.7rem;color:var(--muted);margin-top:.2rem}

/* ‚îÄ‚îÄ COLLAGE PICKER ‚îÄ‚îÄ */
#collage-picker{}
.style-grid{display:grid;grid-template-columns:1fr 1fr;gap:.75rem;margin-top:1rem}
@media(max-width:480px){.style-grid{grid-template-columns:1fr}}
.style-card{
  display:flex;flex-direction:column;align-items:center;gap:.4rem;
  padding:1rem;border-radius:12px;cursor:pointer;border:2px solid var(--border);
  background:var(--card);transition:all .22s;color:var(--text)
}
.style-card.bosch{border-color:#c084fc}.style-card.bosch:hover{background:#1a0f2a}
.style-card.vangogh{border-color:#fbbf24}.style-card.vangogh:hover{background:#1a1500}
.style-emoji{font-size:1.8rem}
.style-name{font-weight:700;font-size:.9rem}
.style-sub{font-size:.72rem;color:var(--muted)}

/* ‚îÄ‚îÄ COLLAGE GAME ‚îÄ‚îÄ */
#collage-game{max-width:min(90vw,1700px);margin:0 auto;padding-left:0;padding-right:0}
.collage-layout{display:flex;flex-direction:column;gap:1.25rem;align-items:center}
.collage-img-box{overflow:hidden;border:2px solid var(--border);border-radius:12px;position:relative;width:100%}
.collage-img-box img{width:100%;display:block}
.collage-opts-wrap{width:100%;max-width:860px;padding:0 1rem}
@media(max-width:620px){.collage-opts-wrap{padding:0 .75rem}}
.art-tag{position:absolute;top:8px;left:8px;padding:.2rem .6rem;border-radius:99px;font-size:.72rem;font-weight:700;backdrop-filter:blur(6px)}
.art-tag.bosch{background:rgba(192,132,252,.85);color:#fff}
.art-tag.vangogh{background:rgba(251,191,36,.9);color:#1a1000}
.collage-opts{display:flex;flex-direction:column;gap:.5rem}
.collage-hud-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:.3rem;font-size:.8rem;color:var(--muted)}
.chosen-count{font-weight:700;color:var(--accent)}
.check-btn{width:100%;padding:.7rem;background:var(--accent);color:#0a0e1a;border:none;border-radius:8px;font-size:.9rem;font-weight:700;cursor:pointer;transition:opacity .2s;margin-top:.4rem}
.check-btn:disabled{background:var(--border);color:var(--muted);cursor:not-allowed}
.check-btn:not(:disabled):hover{opacity:.85}
.copt{background:var(--card);border:2px solid var(--border);border-radius:9px;padding:.65rem .9rem;text-align:left;color:var(--text);cursor:pointer;font-size:.82rem;line-height:1.4;transition:all .18s;display:flex;align-items:flex-start;gap:.5rem}
.copt:hover:not(:disabled):not(.locked){border-color:var(--accent);background:#1a2235}
.copt.chosen{border-color:var(--accent);background:#0d2040}
.copt.correct{border-color:var(--green);background:#052e16;pointer-events:none}
.copt.wrong-sel{border-color:var(--red);background:#2a0a0a}
.copt.revealed{border-color:var(--green);background:#031a0d;opacity:.65;pointer-events:none}
.copt.locked{opacity:.4;pointer-events:none}
.copt-check{width:19px;height:19px;min-width:19px;border-radius:50%;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:.7rem;margin-top:.1rem;font-weight:700}
.copt.chosen .copt-check{background:var(--accent);border-color:var(--accent);color:#0a0e1a}
.copt.correct .copt-check{background:var(--green);border-color:var(--green);color:#fff}
.copt.wrong-sel .copt-check{background:var(--red);border-color:var(--red);color:#fff}
.copt.revealed .copt-check{background:var(--green);border-color:var(--green);color:#fff}
.copt-src{font-size:.68rem;color:var(--muted);margin-top:.15rem}

/* ‚îÄ‚îÄ RESULT ‚îÄ‚îÄ */
.result-screen{display:none;text-align:center;padding:2.5rem 1rem}
.result-screen.show{display:block}
.result-emoji{font-size:3.5rem;margin-bottom:.6rem}
.result-screen h2{font-size:1.6rem;color:var(--accent);margin-bottom:.4rem}
.result-screen p{color:var(--muted);margin-bottom:1.5rem}
.result-btns{display:flex;gap:.75rem;justify-content:center;flex-wrap:wrap}
.btn{padding:.65rem 1.5rem;border-radius:8px;font-size:.9rem;font-weight:700;cursor:pointer;border:none;transition:opacity .2s}
.btn-primary{background:var(--accent);color:#0a0e1a}.btn-secondary{background:var(--border);color:var(--text)}
.btn:hover{opacity:.85}

@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}

/* ‚îÄ‚îÄ ARCHIVE ‚îÄ‚îÄ */
.archive-btn-wrap{max-width:600px;margin:.75rem auto 0;padding:0 1rem}
.archive-btn{width:100%;padding:.75rem 1rem;background:var(--card);border:1px solid var(--border);color:var(--muted);border-radius:10px;cursor:pointer;font-size:.875rem;transition:all .2s;text-align:left}
.archive-btn:hover{border-color:var(--accent);color:var(--text)}
.archive-list{display:flex;flex-direction:column;gap:.55rem;margin-top:.75rem}
.archive-item{background:var(--card);border:2px solid var(--border);border-radius:10px;padding:.85rem 1rem;cursor:pointer;color:var(--text);font-size:.9rem;font-weight:600;text-align:left;transition:all .2s;display:flex;justify-content:space-between;align-items:center;width:100%}
.archive-item:hover{border-color:var(--accent);background:#111827}
.archive-item.today-item{border-color:var(--accent)}
.ai-modes{font-size:.8rem;color:var(--muted)}
.today-pill{background:var(--accent);color:#0a0e1a;font-size:.7rem;font-weight:700;padding:.15rem .55rem;border-radius:99px}
.archive-empty{color:var(--muted);padding:.5rem 0;font-size:.875rem}
.archive-mode-banner{background:#1a2a1a;border:1px solid var(--green);border-radius:8px;padding:.5rem 1rem;text-align:center;font-size:.8rem;color:var(--green);max-width:600px;margin:.5rem auto 0;display:none}
.archive-mode-banner.show{display:block}
</style>
</head>
<body>

<header>
  <h1>üì∞ News Quiz</h1>
  <p>Match headlines to images ‚Äî beat the clock</p>
  <span class="date-badge" id="date-badge">Loading‚Ä¶</span>
</header>

<!-- MAIN MENU -->
<div id="menu">
  <div class="menu-title">Choose a mode</div>
  <div class="menu-grid">
    <div class="mode-btn de" onclick="startQuiz('germany')">
      <div class="mode-emoji">üá©üá™</div>
      <div class="mode-label">Germany</div>
      <div class="mode-sub">Deutsche News ¬∑ Countdown</div>
    </div>
    <div class="mode-btn world" onclick="startQuiz('world')">
      <div class="mode-emoji">üåç</div>
      <div class="mode-label">World</div>
      <div class="mode-sub">World News ¬∑ Countdown</div>
    </div>
    <div class="mode-btn collage" onclick="showCollagePicker()">
      <div class="mode-emoji">üñºÔ∏è</div>
      <div class="mode-label">Collage</div>
      <div class="mode-sub">4 stories ¬∑ 1 artwork</div>
    </div>
  </div>
  <div class="archive-btn-wrap">
    <button class="archive-btn" onclick="showArchive()">üìÖ Archiv ‚Äî vergangene Tage nachspielen ‚Üí</button>
  </div>
  <div class="archive-mode-banner" id="archive-banner"></div>
</div>

<!-- ARCHIVE SCREEN -->
<div class="screen" id="archive-screen">
  <div style="max-width:600px;margin:0 auto;padding:1rem 1rem 3rem">
    <div class="topbar">
      <button class="back-btn" onclick="goMenu()">‚Üê Menu</button>
      <span class="cat-tag" style="color:var(--muted)">üìÖ Archiv</span>
    </div>
    <div id="archive-list"><div class="archive-empty">Loading‚Ä¶</div></div>
  </div>
</div>

<!-- QUIZ SCREEN -->
<div class="screen" id="quiz-screen">
  <div class="topbar">
    <button class="back-btn" onclick="goMenu()">‚Üê Menu</button>
    <span class="cat-tag" id="quiz-cat-tag"></span>
    <div class="score-hud"><span id="quiz-score">0</span>/4</div>
    <div class="pips" id="quiz-pips"></div>
  </div>
  <div class="round-info">Image <span id="round-num">1</span> of 4</div>
  <div class="countdown-wrap"><div class="countdown-bar" id="cdown-bar"></div></div>
  <div class="quiz-img-wrap">
    <img id="quiz-img" src="" alt="">
    <div class="img-result-overlay" id="img-overlay"></div>
  </div>
  <div class="options" id="options"></div>

  <!-- inline result -->
  <div class="result-screen" id="quiz-result">
    <div class="result-emoji" id="qr-emoji"></div>
    <h2 id="qr-title"></h2>
    <p id="qr-sub"></p>
    <div class="result-btns">
      <button class="btn btn-primary" id="qr-retry" onclick="retryQuiz()">üîÑ Try Again</button>
      <button class="btn btn-secondary" onclick="goMenu()">‚Üê Menu</button>
    </div>
    <br><a href="/" style="color:var(--muted);font-size:.8rem">‚Üê Home</a>
  </div>
</div>

<!-- COLLAGE PICKER -->
<div class="screen" id="collage-picker">
  <div class="topbar">
    <button class="back-btn" onclick="goMenu()">‚Üê Menu</button>
    <span class="cat-tag collage">üñºÔ∏è Collage</span>
  </div>
  <div style="color:var(--muted);font-size:.85rem;margin-bottom:.25rem">Pick a category &amp; art style:</div>
  <div class="style-grid">
    <div class="style-card bosch"   onclick="startCollage('germany','bosch')"><div class="style-emoji">üá©üá™üé®</div><div class="style-name">Germany</div><div class="style-sub">Hieronymus Bosch</div></div>
    <div class="style-card vangogh" onclick="startCollage('germany','vangogh')"><div class="style-emoji">üá©üá™üåª</div><div class="style-name">Germany</div><div class="style-sub">Vincent van Gogh</div></div>
    <div class="style-card bosch"   onclick="startCollage('world','bosch')"><div class="style-emoji">üåçüé®</div><div class="style-name">World</div><div class="style-sub">Hieronymus Bosch</div></div>
    <div class="style-card vangogh" onclick="startCollage('world','vangogh')"><div class="style-emoji">üåçüåª</div><div class="style-name">World</div><div class="style-sub">Vincent van Gogh</div></div>
  </div>
</div>

<!-- COLLAGE GAME -->
<div class="screen" id="collage-game">
  <div class="collage-opts-wrap">
    <div class="topbar">
      <button class="back-btn" onclick="showCollagePicker()">‚Üê Styles</button>
      <span class="cat-tag collage" id="coll-tag"></span>
      <div class="score-hud">Found: <span id="coll-score">0</span>/4</div>
    </div>
    <p style="font-size:.82rem;color:var(--muted);margin-bottom:.75rem"><strong style="color:var(--text)">Collage Mode:</strong> All 4 stories are hidden in this artwork. Select the 4 correct headlines from the 8 options!</p>
  </div>
  <div class="collage-layout">
    <div class="collage-img-box">
      <img id="coll-img" src="" alt="Collage">
      <span class="art-tag" id="coll-art-tag"></span>
    </div>
    <div class="collage-opts-wrap">
      <div class="collage-opts">
        <div class="collage-hud-row">
          <span>Select 4 hidden stories:</span>
          <span class="chosen-count"><span id="coll-chosen">0</span>/4 selected</span>
        </div>
        <div id="coll-opts"></div>
        <button class="check-btn" id="coll-check" disabled onclick="checkCollage()">Check Answers</button>
      </div>
    </div>
  </div>
  <div class="result-screen" id="coll-result">
    <div class="result-emoji" id="cr-emoji"></div>
    <h2 id="cr-title"></h2>
    <p id="cr-sub"></p>
    <div class="result-btns">
      <button class="btn btn-primary" onclick="restartCollage()">üîÑ Again</button>
      <button class="btn btn-secondary" onclick="showCollagePicker()">‚Üê Styles</button>
    </div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// GLOBALS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let Q = null; // quiz-data.json
let currentCat = null, currentStyle = null;

function shuffle(a){const b=[...a];for(let i=b.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[b[i],b[j]]=[b[j],b[i]]}return b}

function show(id){document.querySelectorAll('.screen,#menu').forEach(e=>e.classList.remove('show'));const el=document.getElementById(id);if(el.id==='menu')el.style.display='';else el.classList.add('show')}
function goMenu(){stopTimer();show('menu')}

async function init(){
  Q=await(await fetch('quiz-data.json?t='+Date.now())).json();
  const d=new Date(Q.date+'T00:00:00');
  document.getElementById('date-badge').textContent=d.toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'});
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// QUIZ MODE (countdown, one image at a time)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const TIMER_SEC = 7;
let quizRounds=[], quizIdx=0, quizScore=0, quizTimerRAF=null, timerStart=0;

function startQuiz(cat){
  currentCat=cat;
  quizScore=0; quizIdx=0;

  // Build rounds: 4 images, each with 1 correct + 3 distractors ‚Äî ALL from same category
  const correct = Q.categories[cat];       // 4 items with images
  const otherCat = cat==='germany'?'world':'germany';
  const dPool   = Q.distractors ? Q.distractors[cat] : Q.categories[otherCat]; // fallback: use other category
  const shuffledCorrect = shuffle(correct);

  quizRounds = shuffledCorrect.map(item=>{
    // wrong pool = the other 3 correct headlines + all 4 distractors = 7 options
    const otherCorrect = correct.filter(c=>c.id!==item.id).map(c=>({...c,isCorrect:false}));
    const allWrong = shuffle([...otherCorrect,...dPool.map(d=>({...d,isCorrect:false}))]);
    const distractors = allWrong.slice(0,3);
    const opts = shuffle([{...item,isCorrect:true},...distractors]);
    return {item, opts};
  });

  // Build pip row
  const pips=document.getElementById('quiz-pips');
  pips.innerHTML='';
  for(let i=0;i<4;i++){const p=document.createElement('div');p.className='pip';pips.appendChild(p)}

  document.getElementById('quiz-cat-tag').textContent=cat==='germany'?'üá©üá™ Germany':'üåç World';
  document.getElementById('quiz-cat-tag').className='cat-tag '+cat;
  document.getElementById('quiz-score').textContent='0';
  document.getElementById('quiz-result').classList.remove('show');
  document.getElementById('options').style.display='';
  document.getElementById('quiz-img-wrap')&&(document.querySelector('.quiz-img-wrap').style.display='');

  show('quiz-screen');
  showRound();
}

function retryQuiz(){startQuiz(currentCat)}

function showRound(){
  if(quizIdx>=quizRounds.length){showQuizResult();return}
  const r=quizRounds[quizIdx];
  document.getElementById('round-num').textContent=quizIdx+1;
  document.getElementById('quiz-img').src=r.item.image;
  document.getElementById('img-overlay').style.opacity='0';
  document.getElementById('img-overlay').textContent='';

  const optsEl=document.getElementById('options');
  optsEl.innerHTML='';
  const letters=['A','B','C','D'];
  r.opts.forEach((opt,i)=>{
    const btn=document.createElement('button');
    btn.className='opt';
    btn.innerHTML=`<span class="opt-bullet">${letters[i]}</span><span><span class="opt-text">${opt.headline}</span><div class="opt-src">${opt.source}</div></span>`;
    btn.addEventListener('click',()=>pickOpt(opt.isCorrect,btn,r));
    optsEl.appendChild(btn);
  });

  startTimer();
}

// Timer
function startTimer(){
  stopTimer();
  const bar=document.getElementById('cdown-bar');
  bar.style.transition='none'; bar.style.width='100%'; bar.className='countdown-bar';
  timerStart=performance.now();

  function tick(now){
    const elapsed=(now-timerStart)/1000;
    const remaining=Math.max(0,1-elapsed/TIMER_SEC);
    bar.style.transition=`width ${1/60}s linear`;
    bar.style.width=(remaining*100)+'%';
    if(remaining<0.3) bar.className='countdown-bar urgent';
    if(remaining<=0){timeout();return}
    quizTimerRAF=requestAnimationFrame(tick);
  }
  quizTimerRAF=requestAnimationFrame(tick);
}

function stopTimer(){if(quizTimerRAF){cancelAnimationFrame(quizTimerRAF);quizTimerRAF=null}}

function timeout(){
  stopTimer();
  // mark all wrong (no answer)
  document.querySelectorAll('.opt').forEach(b=>{b.disabled=true});
  // reveal correct
  revealCorrect(quizRounds[quizIdx]);
  updatePip('timeout');
  const overlay=document.getElementById('img-overlay');
  overlay.textContent='‚è±Ô∏è'; overlay.style.opacity='1';
  setTimeout(nextRound,1400);
}

function pickOpt(isCorrect, btn, round){
  stopTimer();
  document.querySelectorAll('.opt').forEach(b=>b.disabled=true);
  btn.classList.add(isCorrect?'correct':'wrong');
  btn.querySelector('.opt-bullet').textContent=isCorrect?'‚úì':'‚úó';
  if(!isCorrect) revealCorrect(round);

  const overlay=document.getElementById('img-overlay');
  overlay.textContent=isCorrect?'‚úÖ':'‚ùå'; overlay.style.opacity='1';

  updatePip(isCorrect?'ok':'fail');
  if(isCorrect){quizScore++;document.getElementById('quiz-score').textContent=quizScore}
  setTimeout(nextRound,1400);
}

function revealCorrect(round){
  document.querySelectorAll('.opt').forEach((btn,i)=>{
    if(round.opts[i].isCorrect){btn.classList.add('correct');btn.querySelector('.opt-bullet').textContent='‚úì'}
  });
}

function updatePip(status){
  const pip=document.querySelectorAll('#quiz-pips .pip')[quizIdx];
  if(pip) pip.classList.add(status);
}

function nextRound(){quizIdx++;showRound()}

function showQuizResult(){
  document.getElementById('options').style.display='none';
  document.querySelector('.quiz-img-wrap').style.display='none';
  document.querySelector('.countdown-wrap').style.display='none';
  const screen=document.getElementById('quiz-result');
  screen.classList.add('show');
  const s=quizScore;
  const emojis=['üòµ','üòÖ','ü§î','üëç','üèÜ'];
  const titles=['Tough one!','Getting there!','Solid!','Almost perfect!','Perfect!'];
  const subs=['The news was tricky today.','Keep watching the headlines.','You know your stuff!','Just one slipped by!','You nailed every headline!'];
  document.getElementById('qr-emoji').textContent=emojis[s];
  document.getElementById('qr-title').textContent=titles[s];
  document.getElementById('qr-sub').textContent=`${s}/4 correct. ${subs[s]}`;
  // reset hidden elements for next time
  setTimeout(()=>{
    document.querySelector('.quiz-img-wrap').style.display='';
    document.querySelector('.countdown-wrap').style.display='';
  },100);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// COLLAGE MODE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let collageChosen=new Set(), collageChecked=false;

function showCollagePicker(){stopTimer();show('collage-picker')}

function startCollage(cat,style){
  currentCat=cat; currentStyle=style;
  collageChosen=new Set(); collageChecked=false;

  const info=Q.collages[cat][style];
  document.getElementById('coll-img').src=info.image;
  const artTag=document.getElementById('coll-art-tag');
  artTag.textContent=info.style; artTag.className='art-tag '+style;
  document.getElementById('coll-tag').textContent=(cat==='germany'?'üá©üá™ Germany':'üåç World')+' ¬∑ '+info.style;
  document.getElementById('coll-score').textContent='0';
  document.getElementById('coll-chosen').textContent='0';
  document.getElementById('coll-check').disabled=true;
  document.getElementById('coll-result').classList.remove('show');
  document.querySelector('.collage-layout').style.display='';

  // Collage: 4 correct (with images) + 4 distractors = 8 options
  const correct=Q.categories[cat];
  const otherCatC=cat==='germany'?'world':'germany';
  const distractors=Q.distractors ? Q.distractors[cat] : Q.categories[otherCatC];
  const allOpts=shuffle([...correct.map(i=>({...i,isCorrect:true})),...distractors.map(i=>({...i,isCorrect:false}))]);

  const optsEl=document.getElementById('coll-opts');
  optsEl.innerHTML='';
  allOpts.forEach(item=>{
    const btn=document.createElement('button');
    btn.className='copt'; btn.dataset.id=item.id; btn.dataset.correct=item.isCorrect;
    btn.innerHTML=`<span class="copt-check"></span><span>${item.headline}<div class="copt-src">${item.source}</div></span>`;
    btn.addEventListener('click',()=>toggleCOpt(item.id,btn));
    optsEl.appendChild(btn);
  });

  show('collage-game');
}

function toggleCOpt(id,btn){
  if(collageChecked||btn.classList.contains('correct')||btn.classList.contains('revealed'))return;
  if(collageChosen.has(id)){
    collageChosen.delete(id); btn.classList.remove('chosen'); btn.querySelector('.copt-check').textContent='';
  } else {
    if(collageChosen.size>=4)return;
    collageChosen.add(id); btn.classList.add('chosen'); btn.querySelector('.copt-check').textContent='‚úì';
  }
  const n=collageChosen.size;
  document.getElementById('coll-chosen').textContent=n;
  document.getElementById('coll-check').disabled=n<4;
}

function checkCollage(){
  collageChecked=true;
  let score=0;
  document.querySelectorAll('.copt').forEach(btn=>{
    const id=btn.dataset.id, isCorrect=btn.dataset.correct==='true', wasChosen=collageChosen.has(id);
    if(wasChosen&&isCorrect){btn.classList.remove('chosen');btn.classList.add('correct');btn.querySelector('.copt-check').textContent='‚úì';score++}
    else if(wasChosen&&!isCorrect){btn.classList.remove('chosen');btn.classList.add('wrong-sel');btn.querySelector('.copt-check').textContent='‚úó'}
    else if(!wasChosen&&isCorrect){btn.classList.add('revealed');btn.querySelector('.copt-check').textContent='‚úì'}
    else btn.classList.add('locked');
  });
  document.getElementById('coll-score').textContent=score;
  document.getElementById('coll-check').disabled=true;
  setTimeout(()=>showCollageResult(score),600);
}

function showCollageResult(score){
  document.querySelector('.collage-layout').style.display='none';
  const screen=document.getElementById('coll-result'); screen.classList.add('show');
  const emojis=['üòµ','üòÖ','ü§î','üëç','üèÜ'];
  const titles=['Completely stumped!','Getting warmer!','Good eye!','Almost!','Perfect eye!'];
  const subs=['The artist was sneaky.','Try a different style!','You spotted most of them!','One story slipped by!','You can read art like a newspaper!'];
  document.getElementById('cr-emoji').textContent=emojis[score];
  document.getElementById('cr-title').textContent=titles[score];
  document.getElementById('cr-sub').textContent=`${score}/4 stories found. ${subs[score]}`;
}
function restartCollage(){startCollage(currentCat,currentStyle)}

// ‚îÄ‚îÄ ARCHIVE ‚îÄ‚îÄ
let originalQ = null;

async function showArchive() {
  show('archive-screen');
  const listEl = document.getElementById('archive-list');
  listEl.innerHTML = '<div class="archive-empty">Loading‚Ä¶</div>';
  try {
    const index = await (await fetch('archive-index.json?t='+Date.now())).json();
    listEl.innerHTML = '';

    // Today's entry always first
    const todayBtn = document.createElement('button');
    todayBtn.className = 'archive-item today-item';
    const td = new Date((originalQ||Q).date+'T00:00:00');
    todayBtn.innerHTML = `<span>${td.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'})}</span><span class="today-pill">Today</span>`;
    todayBtn.onclick = loadTodayQuiz;
    listEl.appendChild(todayBtn);

    if (!index.length) {
      const note = document.createElement('div');
      note.className = 'archive-empty';
      note.textContent = 'No archived days yet ‚Äî check back tomorrow!';
      listEl.appendChild(note);
      return;
    }
    index.forEach(date => {
      const d = new Date(date+'T00:00:00');
      const label = d.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'});
      const btn = document.createElement('button');
      btn.className = 'archive-item';
      btn.innerHTML = `<span>${label}</span><span class="ai-modes">üá©üá™ &nbsp;üåç &nbsp;üñºÔ∏è</span>`;
      btn.onclick = () => loadArchivedQuiz(date);
      listEl.appendChild(btn);
    });
  } catch(e) {
    listEl.innerHTML = '<div class="archive-empty">No archive available yet ‚Äî check back tomorrow!</div>';
  }
}

async function loadArchivedQuiz(date) {
  if (!originalQ) originalQ = Q;
  try {
    Q = await (await fetch(`quiz-data-${date}.json?t=`+Date.now())).json();
    const d = new Date(date+'T00:00:00');
    const label = d.toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'});
    document.getElementById('date-badge').textContent = 'üìÖ '+label;
    const banner = document.getElementById('archive-banner');
    banner.textContent = 'üìÖ Playing archive: '+label+' ‚Äî ';
    const back = document.createElement('span');
    back.style.cssText = 'cursor:pointer;text-decoration:underline';
    back.textContent = 'back to today';
    back.onclick = loadTodayQuiz;
    banner.appendChild(back);
    banner.classList.add('show');
    goMenu();
  } catch(e) {
    alert('Could not load archive for '+date);
  }
}

function loadTodayQuiz() {
  if (originalQ) { Q = originalQ; originalQ = null; }
  const d = new Date(Q.date+'T00:00:00');
  document.getElementById('date-badge').textContent = d.toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'});
  document.getElementById('archive-banner').classList.remove('show');
  goMenu();
}

// ‚îÄ‚îÄ BOOT ‚îÄ‚îÄ
init().catch(()=>{document.querySelector('header p').textContent='Failed to load quiz data.'});
</script>
</body>
</html>
